# Настройка роутера OpenWRT (TP-Link, Xiaomi)

## 1. Вход в админку

Подключаетесь к роутеру по вайфаю или проводу. В браузере в адресной строке вбиваете адрес `http://192.168.1.1/` либо `http://openwrt.lan/` (даже, если винда пишет "без доступа к интернету"). Вас перенаправит на админку роутера (http://192.168.1.1/cgi-bin/luci/)

<p align="center">
<img src="img/owrt/image25.png">
</p>

Вход в админку с логином root и без пароля. Позднее его можно установить на вкладке System - Administration.

<p align="center">
<img src="img/owrt/image26.png?">
</p>

Интерфейс LuCI для ОС OpenWRT выглядит следующим образом.

<p align="center">
<img src="img/owrt/image9.png">
</p>

## 2. Подмена MAC адреса (если ранее был подключен без роутера)

__[Как узнать MAC адрес и какой мне нужен](./6-macaddr.md) - помощь__

* Подмена MAC адреса не требуется, если ранее тариф провайдера не подключался, и нет активных устройств к подключением к Интернету на данной учетной записи МИЭТ. Тогда раздел можно пропустить.
* Если раньше было настроено устройство - подменяем мак адрес WAN интерфейса здесь.

В интерфейсе переходим на вкладку Network - Interfaces.
Там подвкладка Devices.

<p align="center"><img src="img/owrt/image10.png?"></p>

Выбираем eht0.2 (либо в редких случаях eth1). Нажимаем на Configure.

<p align="center"><img src="img/owrt/image17.png?"></p>

Узнаём MAC адрес устройства, на котором ранее осуществлялось подключение.

__[Как узнать MAC адрес и какой мне нужен](./6-macaddr.md) - помощь__

Вписываем его на место существующего MAC адреса.

<p align="center"><img src="img/owrt/image7.png?"></p>

Save, затем Save & Apply.

__Заметка:__ в ранних версиях OpenWRT подвкладки Devices нет и подмена MAC производится прямо в подвкладке Interfaces, на интерфейсе WAN:

<p align="center"><img src="img/owrt/image8.png?"></p>


## Настройки интерфейса WAN

Как правило, здесь ничего трогать не нужно - DHCP стоит по умолчанию. __Статический IP прописывать не нужно, не заработает__.

## 3. Настройка Wi-Fi

Переходим на страницу __Network - Wireless__.

По умолчанию Wi-Fi в прошивке выключен.

Если роутер однодиапазонный, будет доступна только сеть 2.4 ГГц с радиомодулем radio0. Если двухдиапазонный, будет еще radio1, отвечающий за 5 ГГц.

__Сначала настроим 2.4 ГГц сеть (radio0)__

<p align="center"><img src="img/owrt/image18.png?"></p>

Нажимаем Edit напротив сети, у которой изначально название OpenWrt. Раздел General Setup (верхняя половина) можно пока не трогать.

<p align="center"><img src="img/owrt/image21.png"></p>

Настройки производим в разделе Interface Configuration (нижняя половина).

__3.1. General Setup (здесь устанавливается название сети ESSID)__

<p align="center"><img src="img/owrt/image12.png?"></p>

__3.2. Wireless Security (меняем пароль key и ставим шифрование WPA2-PSK)__

<p align="center"><img src="img/owrt/image13.png?" ></p>

Сохраняем настройки: Save. Под интерфейсом будет указано: Interface has 3 pending changes. Это означает, что настройки будут изменены, но сейчас ожидают подтверждения.

<p align="center"><img src="img/owrt/image20.png?"></p>

Можно нажать на Save&Apply внизу страницы либо продолжить настройку точки доступа 5 ГГц.

<p align="center"><img src="img/owrt/image23.png"></p>


__Настройки для 5 ГГц (radio1) чуть сложнее__

Под радиомодулем radio1 будет такая же заготовка под точку доступа, но уже в диапазоне 5 ГГц.

<p align="center"><img src="img/owrt/image19.png?"></p>

__3.3. General Setup (здесь устанавливается название сети ESSID)__

<p align="center"><img src="img/owrt/image12.png?"></p>

__3.4. Wireless Security (меняем пароль key и ставим шифрование WPA2-PSK)__

<p align="center"><img src="img/owrt/image13.png?" ></p>

__3.5. Advanced Settings в Device Configuration__

Здесь необходимо выставить Contry Code RU:

<p align="center"><img src="img/owrt/image22.png?" ></p>

Теперь нужно сохранить настройки через Save и затем Save&Apply. Тогда для сети применятся основные настройки.

<p align="center"><img src="img/owrt/image20.png?"></p>

<p align="center"><img src="img/owrt/image23.png"></p>

Однако здесь ещё не всё - после выставления правильного кода страны мы можем установить нужный нам канал Wi-Fi.

__3.6. General Setup в Device Configuration__

Снова открываем для редактирования точку доступа 5 ГГц, Edit. Настройки в разделе General Setup в верхней половине.
Выбираем здесь канал для работы 5 ГГц через выпадающее меню. 

<p align="center"><img src="img/owrt/image24.png?"></p>

Save, Save & Apply.

__3.7. Включение__

Теперь можно включить обе сети.

<p align="center"><img src="img/owrt/image28.png"></p>

Стоит обратить внимание, что Enable работает и внутри настроек Edit для точки доступа - тогда можно не выходить из этого меню, нажимая Save, а сразу активировать точку доступа - настройки оно тоже применит.

<p align="center"><img src="img/owrt/image27.png"></p>
Стоит обратить, что на 5 ГГц будет стоять выбранный нами канал.

__Вот так это будет выглядеть с уже подключенными клиентами:__

<p align="center"><img src="img/owrt/image14.png"></p>



## 4. Настройка времени

На вкладке System – System нажимаем Sync with browser рядом с полем текущего времени. Оно может отличаться от системного на 3 часа, как правило, не играет роли. Достаточно, чтобы совпадала дата.

<p align="center"><img src="img/owrt/image15.png?"></p>

Точно так же Save & Apply.

## 5. Настройка авторизации в сети МИЭТ
На вкладке MIET (в ранних версиях модуля – Interfaces – mschapv2) устанавливаем логин и пароль от ОРИОКС.
Сохраняем кнопкой Save.

<p align="center"><img src="img/owrt/image16.png?"></p>

__Disable/Enable__ отвечает за автозапуск сервиса при включении

__Stop/Start__ отвечает за запуск службы авторизации в настоящее время

__Заметка__. Если любое действие на вкладке выпадает в ошибку, это старая версия модуля и придется ручками [по инструкции, раздел 802.1x](./4-setup-owrt-cli.md).


## 6. Перезагрузка

Чтобы все норм заработало, перезагружаем роутер.


## Диагностика


Заходим на вкладку 192.168.1.1 Network - Interfaces. Смотрим на WAN.

<p align="center"><img src="img/owrt/1.png"></p>

__На интерфейсе RX: 0 B (0 Pkts)__ - провод не подключен или неисправен. 
[Как найти провод от провайдера и определить рабочий](./6-wire.md). Еще можно проверять статус через Network - Switch, там отображается статус портов.

<p align="center"><img src="img/owrt/2.png"></p>

**На интерфейсе RX и TX больше 0**, но не появляются строки Uptime и IPv4. Значит нужно проверить:

* Дату (system system)
* Корректность введённых данных в MIET (mschapv2).
* Включенность сервиса авторизации там же (кнопки красные).
* Логи авторизации там же (о них чуть ниже)

<p align="center"><img src="img/owrt/3.png">< /p>

**На интерфейсе есть IPv4**

Ура!

* Если вы еще не подключали тариф, то всё хорошо, и есть смысл идти дальше - к регистрации у провайдера и подключению тарифа. Ориокс загрузится уже сейчас.
* Если тариф подключался, но сейчас интернета нет - указан неверный MAC адрес.
* Если тариф подключался, и интернет есть - всё тоже отлично.

## Про логи на вкладке MIET

Если `Selected interface 'global'`, то сервис авторизации не запущен. Для этого стоит убедиться, что кнопки на владке MIET красные, а если зеленые - запустить.

Если `Selected interface 'eth0.2'` то смотрим:

    EAP state=SUCCESS - всё хорошо
    EAP state=IDLE - безуспешно пытается авторизоваться
    EAP state=FAILURE - все точно плохо

## Нестандартные случаи

Авторизация на владке MIET успешна, IPv4 не появляется:
* либо лежат сервера миэта
* либо попробуйте с учеткой соседа
* либо пишите в онплюс они умеют это чинить

[Следующий шаг: Проверка подключения](./3-check.md)